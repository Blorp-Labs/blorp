name: Mobile Release

on:
  push:

jobs:
  # ios:
  #   name: iOS – Build & Upload to TestFlight
  #   runs-on: macos-15
  #   timeout-minutes: 60
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #
  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: "20.x"
  #         cache: "yarn"
  #
  #     - name: Install JS dependencies
  #       run: corepack enable && yarn install --immutable
  #
  #     - name: Build web assets + cap sync
  #       env:
  #         NODE_OPTIONS: "--max-old-space-size=4096"
  #       run: yarn build
  #
  #     - uses: ruby/setup-ruby@v1
  #       with:
  #         ruby-version: "3.3"
  #         bundler-cache: true
  #
  #     - name: Install CocoaPods
  #       run: pod install --repo-update
  #       working-directory: ios/App
  #
  #     - name: Build and upload to TestFlight
  #       env:
  #         APPLE_ID: ${{ secrets.APPLE_ID }}
  #         ITC_TEAM_ID: ${{ secrets.ITC_TEAM_ID }}
  #         MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
  #         MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
  #         MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
  #         APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
  #         APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
  #         APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
  #       run: bundle exec fastlane ios beta
  #
  #     - name: Upload gym log on failure
  #       if: failure()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: gym-log
  #         path: ~/Library/Logs/gym/
  #         retention-days: 5

  # android:
  #   name: Android – Build & Upload to Play Store + GitHub Release
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 45
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #
  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: "20.x"
  #         cache: "yarn"
  #
  #     - name: Install JS dependencies
  #       run: corepack enable && yarn install --immutable
  #
  #     - name: Build web assets + cap sync
  #       env:
  #         NODE_OPTIONS: "--max-old-space-size=4096"
  #       run: yarn build
  #
  #     - uses: actions/setup-java@v4
  #       with:
  #         distribution: temurin
  #         java-version: "21"
  #         cache: gradle
  #
  #     - uses: ruby/setup-ruby@v1
  #       with:
  #         ruby-version: "3.3"
  #         bundler-cache: true
  #
  #     - name: Decode Android keystore
  #       env:
  #         ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
  #       run: echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > "$RUNNER_TEMP/blorp-release.keystore"
  #
  #     - name: Build AAB + APK and upload to Play Store
  #       env:
  #         ANDROID_KEYSTORE_PATH: ${{ runner.temp }}/blorp-release.keystore
  #         ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
  #         ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
  #         ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
  #         GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
  #       run: bundle exec fastlane android deploy
  #
  #     - name: Upload AAB as Actions artifact
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: android-aab-${{ github.ref_name }}
  #         path: android/app/build/outputs/bundle/release/app-release.aab
  #         retention-days: 90
  #         if-no-files-found: warn
  #
  #     - name: Upload APK as Actions artifact
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: android-apk-${{ github.ref_name }}
  #         path: android/app/build/outputs/apk/release/app-release.apk
  #         retention-days: 90
  #         if-no-files-found: warn

  tauri:
    name: macOS – Build, Sign & Notarize
    runs-on: macos-15
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "yarn"

      - name: Install JS dependencies
        run: corepack enable && yarn install --immutable

      - name: Build web assets
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
        run: yarn vite build && yarn cp-package-json

      - name: Install Rust (universal targets)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Cache Rust build
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Import Developer ID certificates
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_INSTALLER_CERTIFICATE: ${{ secrets.APPLE_INSTALLER_CERTIFICATE }}
          APPLE_INSTALLER_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_INSTALLER_CERTIFICATE_PASSWORD }}
        run: |
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          echo "$APPLE_CERTIFICATE" | base64 --decode > application.p12
          security import application.p12 -k build.keychain \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productbuild
          rm application.p12
          echo "$APPLE_INSTALLER_CERTIFICATE" | base64 --decode > installer.p12
          security import installer.p12 -k build.keychain \
            -P "$APPLE_INSTALLER_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productbuild
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          rm installer.p12

      - name: Build Tauri app (universal)
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        run: yarn tauri build --config '{"build":{"beforeBuildCommand":""}}' --bundles app --target universal-apple-darwin

      - name: Create, notarize and staple .pkg
        env:
          PRODUCTBUILD_SIGNING_IDENTITY: ${{ secrets.PRODUCTBUILD_SIGNING_IDENTITY }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          mkdir -p release
          xcrun productbuild \
            --sign "$PRODUCTBUILD_SIGNING_IDENTITY" \
            --component "./src-tauri/target/universal-apple-darwin/release/bundle/macos/Blorp.app" /Applications \
            release/Mac-Installer.pkg
          echo "$APP_STORE_CONNECT_API_KEY_CONTENT" | base64 --decode > /tmp/notary-key.p8
          xcrun notarytool submit release/Mac-Installer.pkg \
            --key /tmp/notary-key.p8 \
            --issuer "$APP_STORE_CONNECT_ISSUER_ID" \
            --key-id "$APP_STORE_CONNECT_KEY_ID" \
            --wait
          rm /tmp/notary-key.p8
          xcrun stapler staple release/Mac-Installer.pkg

      - name: Collect updater artifacts
        run: |
          cp src-tauri/target/universal-apple-darwin/release/bundle/macos/Blorp.app.tar.gz release/Mac-Blorp.app.tar.gz
          version=$(jq -r .version package.json)
          sig=$(< "src-tauri/target/universal-apple-darwin/release/bundle/macos/Blorp.app.tar.gz.sig")
          cat > release/latest.json <<EOF
          {
            "version": "$version",
            "platforms": {
              "darwin-aarch64": {
                "signature": "$sig",
                "url": "https://github.com/Blorp-Labs/blorp/releases/download/v$version/Mac-Blorp.app.tar.gz"
              },
              "darwin-x86_64": {
                "signature": "$sig",
                "url": "https://github.com/Blorp-Labs/blorp/releases/download/v$version/Mac-Blorp.app.tar.gz"
              }
            }
          }
          EOF

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-release-${{ github.ref_name }}
          path: release/
          retention-days: 90
          if-no-files-found: error
